name: Build and release Aseprite (macOS Apple Silicon)

on:
  push:
    branches:
      - main
    paths:
      - 'BuildLog.md'
  workflow_dispatch:

env:
  BUILD_TYPE: RelWithDebInfo
  SKIA_TAG: m124-08a5439a6b
  SKIA_ZIP_NAME: Skia-macOS-Release-arm64.zip
  SKIA_URL: https://github.com/aseprite/skia/releases/download/m124-08a5439a6b/Skia-macOS-Release-arm64.zip

jobs:
  build-aseprite:
    name: Build Aseprite (Apple Silicon)
    runs-on: macos-14
    permissions:
      contents: write
    outputs:
      aseprite-tag: ${{ steps.get-latest-tag.outputs.tag }}
      artifact-name: ${{ steps.package.outputs.artifact_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Get the latest Aseprite release tag and source ZIP URL
      - name: Get latest Aseprite tag
        id: get-latest-tag
        shell: bash
        run: |
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/aseprite/aseprite/releases/latest \
            | grep -o '"tag_name": "[^"]*"' \
            | cut -d'"' -f4)
          echo "Latest Aseprite tag: $LATEST_RELEASE"

          ASEZIP=$(curl -s https://api.github.com/repos/aseprite/aseprite/releases/latest \
            | grep -o '"browser_download_url": "[^"]*"' \
            | cut -d'"' -f4)

          echo "ASEZIP=$ASEZIP" >> $GITHUB_ENV
          echo "tag=$LATEST_RELEASE" >> $GITHUB_OUTPUT

      - name: Show basic environment info
        shell: bash
        run: |
          echo "Runner OS: $RUNNER_OS"
          echo "PWD: $(pwd)"
          xcodebuild -version || true
          cmake --version || true
          ninja --version || true

      - name: Ensure dependencies (cmake, ninja, libyaml) installed via Homebrew
        shell: bash
        run: |
          if ! command -v brew >/dev/null 2>&1; then
            echo "Homebrew not installed on this runner, installing..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            eval "$(/opt/homebrew/bin/brew shellenv)" || true
          else
            echo "Homebrew found."
          fi

          brew update
          brew install cmake ninja libyaml || true

          echo "cmake path: $(which cmake || echo 'not found')"
          echo "ninja path: $(which ninja || echo 'not found')"

      - name: Prepare directories and download Aseprite / Skia
        id: prepare-deps
        shell: bash
        run: |
          set -euo pipefail

          ROOT="$PWD"
          DEPS="$ROOT/deps"
          ASEPRITE="$DEPS/aseprite"
          SKIA="$DEPS/skia"

          echo "ROOT=$ROOT" >> $GITHUB_ENV
          echo "DEPS=$DEPS" >> $GITHUB_ENV
          echo "ASEPRITE=$ASEPRITE" >> $GITHUB_ENV
          echo "SKIA=$SKIA" >> $GITHUB_ENV

          mkdir -p "$DEPS"

          echo "== Aseprite source =="
          if [ -d "$ASEPRITE" ]; then
            echo "Aseprite directory already exists: $ASEPRITE"
          else
            echo "Aseprite not found, downloading from: $ASEZIP"
            rm -f "$TMPDIR/asesrc.zip"
            curl "$ASEZIP" -L -o "$TMPDIR/asesrc.zip"
            mkdir -p "$ASEPRITE"
            unzip -q "$TMPDIR/asesrc.zip" -d "$ASEPRITE"
            echo "Aseprite downloaded and extracted to $ASEPRITE"
          fi

          echo "== Skia =="
          if [ -d "$SKIA" ]; then
            echo "Skia directory already exists: $SKIA"
          else
            echo "Skia not found, downloading from: $SKIA_URL"
            rm -f "$TMPDIR/skia.zip"
            curl "$SKIA_URL" -L -o "$TMPDIR/skia.zip"
            mkdir -p "$SKIA"
            unzip -q "$TMPDIR/skia.zip" -d "$SKIA"
            echo "Skia downloaded and extracted to $SKIA"
          fi

      - name: Configure CMake (Apple Silicon)
        shell: bash
        env:
          ARCH: arm64
        run: |
          set -euo pipefail

          cd "$ASEPRITE"

          rm -rf build
          mkdir build
          cd build

          cmake \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
            -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \
            -DCMAKE_OSX_SYSROOT=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk \
            -DLAF_BACKEND=skia \
            -DSKIA_DIR="$SKIA" \
            -DSKIA_LIBRARY_DIR="$SKIA/out/Release-arm64" \
            -DSKIA_LIBRARY="$SKIA/out/Release-arm64/libskia.a" \
            -DPNG_ARM_NEON:STRING=on \
            -G Ninja \
            ..

      - name: Build Aseprite
        shell: bash
        run: |
          set -euo pipefail
          cd "$ASEPRITE/build"
          ninja aseprite

      - name: Create Aseprite.app bundle (auto template + icon)
        shell: bash
        id: package
        run: |
          set -euo pipefail

          ROOT="$PWD"
          APPDIR="$ROOT/Aseprite.app"

          echo "ROOT (repo): $ROOT"
          echo "APPDIR: $APPDIR"

          # 1) Make bundle directories
          mkdir -p "$APPDIR/Contents/MacOS"
          mkdir -p "$APPDIR/Contents/Resources"

          # 2) Copy binary and data into the bundle
          cp "$ASEPRITE/build/bin/aseprite" "$APPDIR/Contents/MacOS/"
          cp -R "$ASEPRITE/build/bin/data" "$APPDIR/Contents/Resources/"

          # 3) Generate .icns icon from Aseprite's PNG icons, if available
          ICON_BASE="$ASEPRITE/data/icons"
          ICONSET_DIR="$ROOT/Aseprite.iconset"

          if [ -f "$ICON_BASE/ase16.png" ] && [ -f "$ICON_BASE/ase32.png" ] && [ -f "$ICON_BASE/ase64.png" ] && [ -f "$ICON_BASE/ase128.png" ] && [ -f "$ICON_BASE/ase256.png" ]; then
            echo "Generating Aseprite.icns from data/icons PNGs..."

            rm -rf "$ICONSET_DIR"
            mkdir -p "$ICONSET_DIR"

            # 16/32
            cp "$ICON_BASE/ase16.png"  "$ICONSET_DIR/icon_16x16.png"
            cp "$ICON_BASE/ase32.png"  "$ICONSET_DIR/icon_16x16@2x.png"
            cp "$ICON_BASE/ase32.png"  "$ICONSET_DIR/icon_32x32.png"
            cp "$ICON_BASE/ase64.png"  "$ICONSET_DIR/icon_32x32@2x.png"

            # 128/256
            cp "$ICON_BASE/ase128.png" "$ICONSET_DIR/icon_128x128.png"
            cp "$ICON_BASE/ase256.png" "$ICONSET_DIR/icon_128x128@2x.png"
            cp "$ICON_BASE/ase256.png" "$ICONSET_DIR/icon_256x256.png"

            # 512 + 1024 from 256, upscaled
            sips -z 512 512  "$ICON_BASE/ase256.png" --out "$ICONSET_DIR/icon_256x256@2x.png" >/dev/null
            sips -z 512 512  "$ICON_BASE/ase256.png" --out "$ICONSET_DIR/icon_512x512.png"   >/dev/null
            sips -z 1024 1024 "$ICON_BASE/ase256.png" --out "$ICONSET_DIR/icon_512x512@2x.png" >/dev/null

            # Build icns
            iconutil -c icns "$ICONSET_DIR" -o "$APPDIR/Contents/Resources/Aseprite.icns"

            ICON_FILE="Aseprite.icns"
          else
            echo "Icon PNGs not found at $ICON_BASE, skipping .icns generation."
            ICON_FILE=""
          fi

          # 4) Generate Info.plist on the fly
          LATEST_TAG="${{ steps.get-latest-tag.outputs.tag }}"
          BUNDLE_ID="com.yourname.Aseprite"  # change this to something unique for you

          INFO_PLIST="$APPDIR/Contents/Info.plist"

          cat > "$INFO_PLIST" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>CFBundleName</key>
  <string>Aseprite</string>
  <key>CFBundleDisplayName</key>
  <string>Aseprite</string>
  <key>CFBundleIdentifier</key>
  <string>${BUNDLE_ID}</string>
  <key>CFBundleExecutable</key>
  <string>aseprite</string>
  <key>CFBundlePackageType</key>
  <string>APPL</string>
  <key>CFBundleShortVersionString</key>
  <string>${LATEST_TAG}</string>
  <key>CFBundleVersion</key>
  <string>${LATEST_TAG}</string>
  <key>LSMinimumSystemVersion</key>
  <string>11.0</string>
  <key>LSApplicationCategoryType</key>
  <string>public.app-category.graphics-design</string>
  <key>NSHighResolutionCapable</key>
  <true/>
EOF

          if [ -n "$ICON_FILE" ]; then
            cat >> "$INFO_PLIST" <<EOF
  <key>CFBundleIconFile</key>
  <string>${ICON_FILE}</string>
EOF
          fi

          cat >> "$INFO_PLIST" <<EOF
</dict>
</plist>
EOF

          # 5) Clear quarantine flags just in case
          xattr -r -d com.apple.quarantine "$APPDIR" || true

          # 6) Zip the .app for release
          ARTIFACT_NAME="Aseprite-${LATEST_TAG}-macOS-arm64.app.zip"
          cd "$ROOT"
          zip -r "$ARTIFACT_NAME" "Aseprite.app"

          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Upload artifact (for debugging / manual download)
        uses: actions/upload-artifact@v4
        with:
          name: aseprite-macos-apple-silicon
          path: ${{ steps.package.outputs.artifact_name }}

  create-release:
    name: Create GitHub Release and upload asset
    needs: build-aseprite
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: aseprite-macos-apple-silicon
          path: dist

      - name: Create GitHub Release (if not exists)
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.build-aseprite.outputs.aseprite-tag }}
          body: Aseprite-${{ needs.build-aseprite.outputs.aseprite-tag }} for macOS Apple Silicon
          skipIfReleaseExists: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload asset to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/${{ needs.build-aseprite.outputs.artifact-name }}
          asset_name: ${{ needs.build-aseprite.outputs.artifact-name }}
          tag: ${{ needs.build-aseprite.outputs.aseprite-tag }}
