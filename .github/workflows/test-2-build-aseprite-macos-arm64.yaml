name: Test 2 Build and release Aseprite (macOS Apple Silicon)

on:
  push:
    branches:
      - main
    paths:
      - 'BuildLog.md'
  workflow_dispatch:

env:
  BUILD_TYPE: RelWithDebInfo
  SKIA_TAG: m124-08a5439a6b
  SKIA_ZIP_NAME: Skia-macOS-Release-arm64.zip
  SKIA_URL: https://github.com/aseprite/skia/releases/download/m124-08a5439a6b/Skia-macOS-Release-arm64.zip

jobs:
  build-aseprite:
    name: Build Aseprite (Apple Silicon)
    runs-on: macos-14
    permissions:
      contents: write
    outputs:
      aseprite-tag: ${{ steps.get-latest-tag.outputs.tag }}
      artifact-name: ${{ steps.package.outputs.artifact_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Get the latest Aseprite release tag and source ZIP URL
      - name: Get latest Aseprite tag
        id: get-latest-tag
        shell: bash
        run: |
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/aseprite/aseprite/releases/latest \
            | grep -o '"tag_name": "[^"]*"' \
            | cut -d'"' -f4)
          echo "Latest Aseprite tag: $LATEST_RELEASE"

          ASEZIP=$(curl -s https://api.github.com/repos/aseprite/aseprite/releases/latest \
            | grep -o '"browser_download_url": "[^"]*"' \
            | cut -d'"' -f4)

          echo "ASEZIP=$ASEZIP" >> $GITHUB_ENV
          echo "tag=$LATEST_RELEASE" >> $GITHUB_OUTPUT

      - name: Show basic environment info
        shell: bash
        run: |
          echo "Runner OS: $RUNNER_OS"
          echo "PWD: $(pwd)"
          xcodebuild -version || true
          cmake --version || true
          ninja --version || true

      - name: Ensure dependencies (cmake, ninja, libyaml) installed via Homebrew
        shell: bash
        run: |
          if ! command -v brew >/dev/null 2>&1; then
            echo "Homebrew not installed on this runner, installing..."
