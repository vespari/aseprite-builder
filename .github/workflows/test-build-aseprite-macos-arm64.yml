name: (Test 1) Build and release Aseprite (macOS Sequoia / Apple Silicon)

on:
  push:
    branches:
      - main
    paths:
      - 'BuildLog.md'
  workflow_dispatch:

env:
  # Match the scripts: RelWithDebInfo, arm64 Skia bundle
  BUILD_TYPE: RelWithDebInfo
  SKIA_TAG: m124-08a5439a6b
  SKIA_ZIP_NAME: Skia-macOS-Release-arm64.zip

jobs:
  fetch-aseprite-info:
    name: Fetch latest Aseprite release
    runs-on: ubuntu-latest
    outputs:
      release-tag: ${{ steps.aseprite-release.outputs.release-tag }}
    steps:
      - name: Get latest Aseprite release tag
        id: aseprite-release
        shell: bash
        run: |
          set -euo pipefail
          API_URL="https://api.github.com/repos/aseprite/aseprite/releases/latest"
          JSON=$(curl -s "$API_URL")

          TAG=$(echo "$JSON" \
            | grep -m1 -o '"tag_name": "[^"]*"' \
            | cut -d'"' -f4)

          if [ -z "$TAG" ]; then
            echo "Failed to find tag_name in $API_URL response"
            exit 1
          fi

          echo "Latest Aseprite tag: $TAG"
          echo "release-tag=$TAG" >> "$GITHUB_OUTPUT"

  create-release:
    name: Ensure local Release exists
    runs-on: ubuntu-latest
    needs: fetch-aseprite-info
    permissions:
      contents: write
    outputs:
      release-tag: ${{ needs.fetch-aseprite-info.outputs.release-tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Create GitHub Release (if missing)
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.fetch-aseprite-info.outputs.release-tag }}
          body: Aseprite-${{ needs.fetch-aseprite-info.outputs.release-tag }}
          skipIfReleaseExists: true
          token: ${{ secrets.GITHUB_TOKEN }}

  build-aseprite:
    name: Build Aseprite (macOS 15 Apple Silicon)
    needs: create-release
    runs-on: macos-15   # Apple Silicon Sequoia runner
    permissions:
      contents: write
    env:
      ASEPRITE_TAG: ${{ needs.create-release.outputs.release-tag }}
    steps:
      - name: Checkout repo (for template & scripts)
        uses: actions/checkout@v4

      - name: Ensure Ninja is available
        uses: aseprite/get-ninja@main

      - name: Show toolchain versions (debug)
        shell: bash
        run: |
          echo "Using Aseprite tag: $ASEPRITE_TAG"
          cmake --version || true
          ninja --version || true
          xcodebuild -version || true

      - name: Fetch Aseprite source and Skia
        shell: bash
        run: |
          set -euo pipefail

          ROOT="$PWD"
          DEPS="$ROOT/deps"
          ASE_SRC="$DEPS/aseprite"
          SKIA_DEST="$DEPS/skia-${SKIA_TAG}"

          echo "ROOT=$ROOT" >> "$GITHUB_ENV"
          echo "DEPS=$DEPS" >> "$GITHUB_ENV"
          echo "ASE_SRC=$ASE_SRC" >> "$GITHUB_ENV"
          echo "SKIA_DEST=$SKIA_DEST" >> "$GITHUB_ENV"

          rm -rf "$DEPS"
          mkdir -p "$DEPS"

          echo "=== Clone Aseprite source at tag ${ASEPRITE_TAG} ==="
          git clone --recursive --branch "$ASEPRITE_TAG" \
            https://github.com/aseprite/aseprite.git "$ASE_SRC"

          echo "=== Download Skia (arm64) ==="
          SKIA_URL="https://github.com/aseprite/skia/releases/download/${SKIA_TAG}/${SKIA_ZIP_NAME}"
          echo "Skia URL: $SKIA_URL"

          curl -L -o "$DEPS/skia.zip" "$SKIA_URL"
          mkdir -p "$SKIA_DEST"
          unzip -q "$DEPS/skia.zip" -d "$SKIA_DEST"

      - name: Configure CMake (Apple Silicon)
        shell: bash
        run: |
          set -euo pipefail

          cd "$ASE_SRC"
          BUILD_DIR="build"
          rm -rf "$BUILD_DIR"
          mkdir "$BUILD_DIR"
          cd "$BUILD_DIR"

          cmake \
            -DCMAKE_BUILD_TYPE="${BUILD_TYPE}" \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \
            -DCMAKE_OSX_SYSROOT="/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk" \
            -DLAF_BACKEND=skia \
            -DSKIA_DIR="$SKIA_DEST" \
            -DSKIA_LIBRARY_DIR="$SKIA_DEST/out/Release-arm64" \
            -DSKIA_LIBRARY="$SKIA_DEST/out/Release-arm64/libskia.a" \
            -DPNG_ARM_NEON:STRING=on \
            -DENABLE_TESTS=OFF \
            -G Ninja \
            ..

      - name: Build Aseprite
        shell: bash
        run: |
          set -euo pipefail
          cd "$ASE_SRC/build"
          ninja aseprite

      - name: Create Aseprite.app bundle from template
        id: package
        shell: bash
        run: |
          set -euo pipefail

          ROOT="$PWD"
          TEMPLATE="$ROOT/Aseprite.app.template"
          APP_BUNDLE="$ROOT/Aseprite.app"

          if [ ! -d "$TEMPLATE" ]; then
            echo "Aseprite.app.template not found at $TEMPLATE"
            exit 1
          fi

          echo "Using template at $TEMPLATE"
          rm -rf "$APP_BUNDLE"
          mkdir -p "$APP_BUNDLE/Contents"

          # Copy template into bundle
          cp -R "$TEMPLATE/." "$APP_BUNDLE/Contents/"
          mkdir -p "$APP_BUNDLE/Contents/MacOS"
          mkdir -p "$APP_BUNDLE/Contents/Resources"

          # Copy built binary + data
          cp "$ASE_SRC/build/bin/aseprite" "$APP_BUNDLE/Contents/MacOS/"
          cp -R "$ASE_SRC/build/bin/data" "$APP_BUNDLE/Contents/Resources/"

          # Update Info.plist version placeholder (matches script 1)
          sed -i "" "s/1.2.34.1/$ASEPRITE_TAG/" "$APP_BUNDLE/Contents/Info.plist" || true

          # Clear quarantine flag if present
          xattr -r -d com.apple.quarantine "$APP_BUNDLE" || true

          ARTIFACT_NAME="Aseprite-${ASEPRITE_TAG}-macOS-arm64.zip"
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> "$GITHUB_ENV"
          echo "artifact_name=$ARTIFACT_NAME" >> "$GITHUB_OUTPUT"

          cd "$ROOT"
          zip -r "$ARTIFACT_NAME" "Aseprite.app"

      - name: Upload release asset
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ steps.package.outputs.artifact_name }}
          asset_name: ${{ steps.package.outputs.artifact_name }}
          tag: ${{ needs.create-release.outputs.release-tag }}
          overwrite: true
